@rendermode InteractiveServer
@using Blzr.BootstrapSelect
@using System.ComponentModel
@using System.Runtime.InteropServices
@page "/"
@implements IDisposable
@inject FactoryService FactoryService

<PageTitle>Satisfactory Factory Tracker</PageTitle>

<div class="container-fluid">
	<div class="row">
		<div class="col-md-9">
			<FactoryManager @ref="factoryManagerComponent" />
		</div>
		<div class="col-md-3">
			<ResourceBalance @ref="resourceBalanceComponent" />
		</div>
	</div>
</div>

<div class="container-fluid mt-3">
	<div class="row">
		<div class="col">
			@foreach  (var recipe in FactoryService.GetAllRecipes())
			{
				// Print name and batch time of each recipe
				<p>@recipe.Name - Batch Time: @recipe.TimeSeconds seconds</p>

				// Add Input and Output details
				<ul>
					<li>Inputs:
						<ul>
							@foreach (var input in recipe.Inputs)
							{
								<li>
									<img src="@input.Part.ImageUrl" alt="@input.Part.Name" style="width:24px; height:24px; margin-right:8px;" />
									@input.Part.Name: @input.Quantity
								</li>
							}
						</ul>
					</li>
					<li>Outputs:
						<ul>
							@foreach (var output in recipe.Outputs)
							{
								<li>
									<img src="@output.Part.ImageUrl" alt="@output.Part.Name" style="width:24px; height:24px; margin-right:8px;" />
									@output.Part.Name: @output.Quantity
								</li>
							}
						</ul>
					</li>
				</ul>
			}
		</div>
	</div>
</div>

@code {
	private ResourceBalance resourceBalanceComponent = default!;
	private FactoryManager factoryManagerComponent = default!;
	private CancellationTokenSource? _componentLifetimeTokenSource;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			_componentLifetimeTokenSource = new CancellationTokenSource();

			// Add a small delay to ensure both components are fully initialized
			try
			{
				await Task.Delay(100, _componentLifetimeTokenSource.Token);
			}
			catch (TaskCanceledException)
			{
				return; // Component is being disposed
			}

			// Ensure the factory manager has the correct reference to the resource balance component
			if (factoryManagerComponent != null && resourceBalanceComponent != null)
			{
				Console.WriteLine("Setting ResourceBalanceComponent in FactoryManager from Home.razor");
				factoryManagerComponent.SetResourceBalanceComponent(resourceBalanceComponent);
				StateHasChanged();
			}
			else
			{
				Console.WriteLine($"Components not ready: FactoryManager={factoryManagerComponent != null}, ResourceBalance={resourceBalanceComponent != null}");
			}
		}
		await base.OnAfterRenderAsync(firstRender);
	}

	public void Dispose()
	{
		// Cancel any ongoing operations
		_componentLifetimeTokenSource?.Cancel();

		// Clean up component references
		resourceBalanceComponent?.Dispose();
		factoryManagerComponent?.Dispose();

		// Dispose cancellation token
		_componentLifetimeTokenSource?.Dispose();
		_componentLifetimeTokenSource = null;
	}
}
